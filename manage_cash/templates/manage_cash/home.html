{% extends "manage_cash/base.html" %}
{% load static %}

{% block title %}Главная — Учёт ДДС{% endblock %}

{% block content %}
<div class="container mt-4">
  <h1 class="mb-4">История транзакций</h1>

  <!-- Статистика -->
  <div class="alert alert-info">
    Всего записей: <strong>{{ transactions.count }}</strong>
  </div>

   <!--Сортировка
   <div class="mb-3">
      <strong>Сортировать по:</strong>
      <a href="?status" class="btn btn-sm btn-outline-primary">Статусу</a>
      <a href="?type" class="btn btn-sm btn-outline-primary">Типу</a>
      <a href="?category" class="btn btn-sm btn-outline-primary">Категории</a>
      <a href="?subcategory" class="btn btn-sm btn-outline-primary">Подкатегории</a>
      <a href="?date" class="btn btn-sm btn-outline-primary">Дате ↑</a>
      <a href="?-date" class="btn btn-sm btn-outline-primary">Дате ↓</a>
    </div>-->
  <!-- Форма фильтрации -->
  <form method="get" class="mb-4 p-3 border rounded bg-light">
    <div class="row g-2">
      <!-- Дата от / до -->
      <div class="col-md-2">
        <label class="form-label">Дата от</label>
        <input type="date" name="start_date" class="form-control" value="{{ request.GET.start_date }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">Дата до</label>
        <input type="date" name="end_date" class="form-control" value="{{ request.GET.end_date }}">
      </div>

      <!-- Статус -->
      <div class="col-md-2">
        <label class="form-label">Статус</label>
        <select name="status" class="form-select">
          <option value="">Все</option>
          {% for s in statuses %}
            <option value="{{ s.id }}" {% if s.id|stringformat:"s" == request.GET.status %}selected{% endif %}>
              {{ s.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Тип -->
      <div class="col-md-2">
        <label class="form-label">Тип</label>
        <select name="type" class="form-select">
          <option value="">Все</option>
          {% for t in types %}
            <option value="{{ t.id }}" {% if t.id|stringformat:"s" == request.GET.type %}selected{% endif %}>
              {{ t.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Категория -->
      <div class="col-md-2">
        <label class="form-label">Категория</label>
        <select name="category" class="form-select">
          <option value="">Все</option>
          {% for c in categories %}
            <option value="{{ c.id }}" {% if c.id|stringformat:"s" == request.GET.category %}selected{% endif %}>
              {{ c.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Подкатегория -->
      <div class="col-md-2">
        <label class="form-label">Подкатегория</label>
        <select name="subcategory" class="form-select">
          <option value="">Все</option>
          {% for sc in subcategories %}
            <option value="{{ sc.id }}" {% if sc.id|stringformat:"s" == request.GET.subcategory %}selected{% endif %}>
              {{ sc.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Кнопки -->
      <div class="col-12 mt-2">
        <button type="submit" class="btn btn-primary">Применить</button>
        <a href="{% url 'manage_cash:home' %}" class="btn btn-secondary">Сбросить</a>
      </div>
    </div>
  </form>
  <!-- Таблица транзакций -->
  {% if transactions %}
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
              <th>Владелец</th>
              <th>Дата</th>
            <th>Статус</th>
            <th>Тип</th>
            <th>Категория</th>
            <th>Подкатегория</th>
            <th>Сумма</th>
            <th>Комментарий</th>
              <th>действия</th>
          </tr>
        </thead>

        <tbody>
          {% for t in transactions %}
            <tr>
              <td>{{ t.owner }}</td>
              <td>{{ t.date }}</td>
              <td>{{ t.status.name }}</td>
              <td>{{ t.type.name }}</td>
              <td>{{ t.category.name }}</td>
              <td>{{ t.subcategory.name }}</td>
              <td>{{ t.amount }} ₽</td>
              <td>{{ t.comment|default:"—" }}</td>
            <td>
            {% if request.user.is_superuser or t.owner == request.user %}
                <!-- Редактировать -->
                <button type="button" class="btn btn-sm btn-outline-warning me-1"
                        data-bs-toggle="modal" data-bs-target="#editTransactionModal"
                        data-id="{{ t.id }}"
                        data-date="{{ t.date }}"
                        data-amount="{{ t.amount }}"
                        data-comment="{{ t.comment|default:'' }}"
                        data-status="{{ t.status_id }}"
                        data-type="{{ t.type_id }}"
                        data-category="{{ t.category_id }}"
                        data-subcategory="{{ t.subcategory_id }}">
                    Изменить
                </button>
        
                <!-- Удалить -->
                <a href="{% url 'manage_cash:transaction_confirm_delete' t.pk %}"
                   class="btn btn-sm btn-danger"
                   onclick="return confirm('Удалить транзакцию от {{ t.date }} на {{ t.amount }} ₽?')">
                    Удалить
                </a>
            {% else %}
                <span class="text-muted">—</span>
            {% endif %}
            {% endfor%}
        </td>
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="text-center text-muted mt-5">
      <p>Нет записей</p>
    </div>
  {% endif %}
</div>
    <!-- Модальное окно редактирования транзакции -->
<div class="modal fade" id="editTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редактировать транзакцию</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editTransactionForm">
                    {% csrf_token %}
                    <input type="hidden" id="edit-transaction-id">
                    <div class="mb-3">
                        <label class="form-label">Дата</label>
                        <input type="date" class="form-control" id="edit-date" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Сумма</label>
                        <input type="number" step="0.01" class="form-control" id="edit-amount" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Комментарий</label>
                        <input type="text" class="form-control" id="edit-comment">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Статус</label>
                        <select class="form-control" id="edit-status" required>
                            {% for s in statuses %}
                                <option value="{{ s.id }}">{{ s.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Тип</label>
                        <select class="form-control" id="edit-type" required>
                            {% for t in types %}
                                <option value="{{ t.id }}">{{ t.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Категория</label>
                        <select class="form-control" id="edit-category" required>
                            {% for c in categories %}
                                <option value="{{ c.id }}">{{ c.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Подкатегория</label>
                        <select class="form-control" id="edit-subcategory" required>
                            {% for sc in subcategories %}
                                <option value="{{ sc.id }}">{{ sc.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div id="edit-error" class="alert alert-danger d-none"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveTransactionBtn">Сохранить</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // === 1. Обработчики для модального окна редактирования ===
    const editModal = document.getElementById('editTransactionModal');

    // Заполнение полей при открытии
    editModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        document.getElementById('edit-transaction-id').value = button.dataset.id;
        document.getElementById('edit-date').value = button.dataset.date;
        document.getElementById('edit-amount').value = button.dataset.amount;
        document.getElementById('edit-comment').value = button.dataset.comment;
        document.getElementById('edit-status').value = button.dataset.status;
        document.getElementById('edit-type').value = button.dataset.type;
        document.getElementById('edit-category').value = button.dataset.category;
        document.getElementById('edit-subcategory').value = button.dataset.subcategory;
        document.getElementById('edit-error').classList.add('d-none');

        // Загружаем категории и подкатегории после заполнения
        setTimeout(() => {
            const typeId = document.getElementById('edit-type').value;
            const catId = document.getElementById('edit-category').value;
            if (typeId) loadCategoriesForType(typeId, 'edit-category');
            if (catId) loadSubcategoriesForCategory(catId, 'edit-subcategory');
        }, 10);
    });

    // Сохранение
    document.getElementById('saveTransactionBtn').addEventListener('click', function () {
        const formData = new FormData();
        formData.append('id', document.getElementById('edit-transaction-id').value);
        formData.append('date', document.getElementById('edit-date').value);
        formData.append('amount', document.getElementById('edit-amount').value);
        formData.append('comment', document.getElementById('edit-comment').value);
        formData.append('status', document.getElementById('edit-status').value);
        formData.append('type', document.getElementById('edit-type').value);
        formData.append('category', document.getElementById('edit-category').value);
        formData.append('subcategory', document.getElementById('edit-subcategory').value);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        fetch('{% url "manage_cash:transaction_update_ajax" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(editModal).hide();
                location.reload();
            } else {
                document.getElementById('edit-error').textContent = data.error;
                document.getElementById('edit-error').classList.remove('d-none');
            }
        });
    });

    // === 2. Функции для динамической фильтрации ===
    function loadCategoriesForType(typeId, selectId) {
        const select = document.getElementById(selectId);
        if (!typeId) {
            select.innerHTML = '<option value="">---------</option>';
            return;
        }
        fetch(`/ajax/categories/?type_id=${typeId}`)
            .then(r => r.json())
            .then(data => {
                select.innerHTML = '<option value="">---------</option>';
                data.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item.id;
                    opt.textContent = item.name;
                    select.appendChild(opt);
                });
            });
    }

    function loadSubcategoriesForCategory(catId, selectId) {
        const select = document.getElementById(selectId);
        if (!catId) {
            select.innerHTML = '<option value="">---------</option>';
            return;
        }
        fetch(`/ajax/subcategories/?category_id=${catId}`)
            .then(r => r.json())
            .then(data => {
                select.innerHTML = '<option value="">---------</option>';
                data.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item.id;
                    opt.textContent = item.name;
                    select.appendChild(opt);
                });
            });
    }

    // === 3. Обработчики смены типа/категории ===
    document.getElementById('edit-type').addEventListener('change', function () {
        const typeId = this.value;
        loadCategoriesForType(typeId, 'edit-category');
        document.getElementById('edit-subcategory').innerHTML = '<option value="">---------</option>';
    });

    document.getElementById('edit-category').addEventListener('change', function () {
        const catId = this.value;
        loadSubcategoriesForCategory(catId, 'edit-subcategory');
    });
});
</script>
{% endblock %}